<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interlinear Bible Reader</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/?size=48&id=ho7FUWP8PGIX&format=png">

    <!-- Google Fonts for reading fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&family=EB+Garamond:wght@400;500;600&family=Inter:wght@400;500;600;700&family=Libre+Baskerville:wght@400;700&family=Literata:wght@400;500;600&family=Lora:wght@400;500;600&family=Merriweather:wght@400;700&family=Open+Sans:wght@400;500;600&family=Roboto:wght@400;500;700&family=Source+Serif+4:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="IBRstyle.css">

    <script>
        // Apply saved settings immediately to prevent flash
        const savedPreset = localStorage.getItem('themePreset');
        const savedFont = localStorage.getItem('fontFamily');
        const savedFontSize = localStorage.getItem('fontSize');
        const savedLineHeight = localStorage.getItem('lineHeight');

        if (savedPreset && savedPreset !== 'default') {
            document.documentElement.setAttribute('data-preset', savedPreset);
        }
        if (savedFont && savedFont !== 'system') {
            document.documentElement.setAttribute('data-font', savedFont);
        }
        if (savedFontSize && savedFontSize !== 'medium') {
            document.documentElement.setAttribute('data-font-size', savedFontSize);
        }
        if (savedLineHeight && savedLineHeight !== 'normal') {
            document.documentElement.setAttribute('data-line-height', savedLineHeight);
        }
    </script>
</head>

<body>

<h1>Interlinear Bible Reader</h1>

    <div id="navBar">
        <div class="nav-group">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" title="Book">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            <select id="bookSelect" title="Select Book"></select>
        </div>
        <div class="nav-group">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" title="Chapter">
                <line x1="4" y1="9" x2="20" y2="9"></line>
                <line x1="4" y1="15" x2="20" y2="15"></line>
                <line x1="10" y1="3" x2="8" y2="21"></line>
                <line x1="16" y1="3" x2="14" y2="21"></line>
            </svg>
            <select id="chapterSelect" title="Select Chapter"></select>
        </div>
        <div class="nav-buttons">
            <button id="prevChapter" title="Previous Chapter">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <button id="nextChapter" title="Next Chapter">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>
        <div class="nav-panel-buttons">
            <button class="nav-panel-btn active" data-panel="word" onclick="switchPanel('word')" title="Word Details">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </button>
            <button class="nav-panel-btn" data-panel="search" onclick="switchPanel('search')" title="Search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
            <button class="nav-panel-btn" data-panel="settings" onclick="switchPanel('settings')" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </div>
    </div>

    <div id="main">
        <div id="biblePanel"></div>
        <div id="resizeHandle" title="Drag to resize panels"></div>
        <div id="sidePanel">
            <!-- Word Details Panel -->
            <div id="panelWord" class="panel-content active">
                <div id="definitionContent">Click a word to see details here.</div>
            </div>

            <!-- Search Panel -->
            <div id="panelSearch" class="panel-content">
                <div class="search-container">
                    <div class="search-box">
                        <div class="search-box-input">
                            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchInput" placeholder="Search for words or phrases..." autocomplete="off">
                        </div>
                        <button id="searchGoBtn" title="Search">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="search-type-toggle">
                        <button class="search-type-btn active" data-type="text">Text Search</button>
                        <button class="search-type-btn" data-type="strongs">Strong's Number</button>
                    </div>
                    <div class="search-options" id="textOptions">
                        <label class="checkbox-label">
                            <input type="checkbox" id="caseSensitive">
                            <span>Case sensitive</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="wholeWord">
                            <span>Whole word only</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="exactPhrase" checked>
                            <span>Exact phrase</span>
                        </label>
                    </div>
                    <p class="search-hint" id="multiWordHint" style="display: none;">Words can appear anywhere in the verse, in any order.</p>
                    <div class="search-options" id="strongsOptions" style="display: none;">
                        <p class="search-hint">Enter a Strong's number (e.g., H430, G2316) to find all occurrences.</p>
                    </div>
                </div>
                <div id="searchStatus" class="search-status"></div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <!-- Settings Panel -->
            <div id="panelSettings" class="panel-content">
                <section class="settings-card">
                    <h2>Typography</h2>
                    <p class="muted">Choose your reading font and size</p>
                    <div class="font-settings">
                        <div class="setting-row">
                            <div>
                                <label for="fontSelect">Reading Font</label>
                                <div class="description">Select a font for Bible text</div>
                            </div>
                            <select id="fontSelect" class="font-select">
                                <optgroup label="System Fonts">
                                    <option value="system">System Default</option>
                                    <option value="georgia">Georgia</option>
                                    <option value="palatino">Palatino</option>
                                    <option value="times">Times New Roman</option>
                                    <option value="garamond">Garamond</option>
                                    <option value="baskerville">Baskerville</option>
                                    <option value="charter">Charter</option>
                                </optgroup>
                                <optgroup label="Serif (Google Fonts)">
                                    <option value="merriweather">Merriweather</option>
                                    <option value="lora">Lora</option>
                                    <option value="source-serif">Source Serif</option>
                                    <option value="literata">Literata</option>
                                    <option value="eb-garamond">EB Garamond</option>
                                    <option value="libre-baskerville">Libre Baskerville</option>
                                </optgroup>
                                <optgroup label="Sans-Serif (Google Fonts)">
                                    <option value="open-sans">Open Sans</option>
                                    <option value="roboto">Roboto</option>
                                    <option value="inter">Inter</option>
                                    <option value="atkinson">Atkinson Hyperlegible</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="setting-row">
                            <div>
                                <label for="fontSizeSelect">Text Size</label>
                                <div class="description">Adjust the reading text size</div>
                            </div>
                            <select id="fontSizeSelect" class="font-select">
                                <option value="small">Small</option>
                                <option value="medium">Medium (Default)</option>
                                <option value="large">Large</option>
                                <option value="x-large">Extra Large</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <div>
                                <label for="lineHeightSelect">Line Spacing</label>
                                <div class="description">Adjust space between lines</div>
                            </div>
                            <select id="lineHeightSelect" class="font-select">
                                <option value="compact">Compact</option>
                                <option value="normal">Normal (Default)</option>
                                <option value="relaxed">Relaxed</option>
                                <option value="spacious">Spacious</option>
                            </select>
                        </div>
                    </div>
                </section>
                <section class="settings-card">
                    <h2>Preview</h2>
                    <div id="fontPreview" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 1rem;">
                        <div class="preview-text" style="padding: 0.75rem; background: var(--bg-surface); border-radius: var(--radius-small); font-family: var(--font-reading); font-size: var(--font-size-base); line-height: var(--line-height-base);">
                            <span style="color: var(--accent-primary); font-weight: 700; margin-right: 0.5rem;">1</span>
                            In the beginning God created the heavens and the earth.
                            <span style="color: var(--accent-primary); font-weight: 700; margin-left: 0.5rem; margin-right: 0.5rem;">2</span>
                            Now the earth was formless and empty, darkness was over the surface of the deep, and the Spirit of God was hovering over the waters.
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            Font: <strong id="currentFontDisplay">System Default</strong> |
                            Size: <strong id="currentSizeDisplay">Medium</strong> |
                            Spacing: <strong id="currentLineHeightDisplay">Normal</strong>
                        </div>
                    </div>
                </section>
                <section class="settings-card">
                    <h2>Theme</h2>
                    <p class="muted">Choose a color theme for the reader</p>
                    <div class="preset-selector">
                        <button class="preset-button" data-preset="default">Default Blue</button>
                        <button class="preset-button" data-preset="dark">Dark Mode</button>
                        <button class="preset-button" data-preset="blue">Ocean Teal</button>
                        <button class="preset-button" data-preset="green">Forest Green</button>
                        <button class="preset-button" data-preset="orange">Sunset Orange</button>
                        <button class="preset-button" data-preset="purple">Purple Haze</button>
                        <button class="preset-button" data-preset="sepia">Sepia Classic</button>
                        <button class="preset-button" data-preset="grayscale">Grayscale</button>
                    </div>
                </section>
                <section class="settings-card">
                    <h2>About</h2>
                    <div class="setting-row">
                        <div>
                            <label>Automatic Saving</label>
                            <div class="description">All settings are saved automatically and will be remembered when you return.</div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <div>
                            <label>Keyboard Shortcut</label>
                            <div class="description">Press <strong>Ctrl + Shift + T</strong> to quickly toggle between light and dark mode.</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        let bibleData = [];
        let strongsData = {};
        let currentChapter = [];
        let bookMap = {}; // book -> chapters

        // ==================== Panel Switching ====================
        let currentPanel = 'word';

        function switchPanel(panelName, scrollToPanel) {
            // Toggle: if already on this panel, switch back to word
            if (currentPanel === panelName && panelName !== 'word') {
                panelName = 'word';
            }
            currentPanel = panelName;

            // Update nav bar buttons
            document.querySelectorAll('.nav-panel-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.panel === panelName);
            });

            // Update panel content visibility
            document.querySelectorAll('.panel-content').forEach(panel => {
                panel.classList.remove('active');
            });
            const targetPanel = document.getElementById('panel' + panelName.charAt(0).toUpperCase() + panelName.slice(1));
            if (targetPanel) targetPanel.classList.add('active');

            // On mobile, scroll to the side panel when requested
            if (scrollToPanel !== false && window.innerWidth <= 900) {
                const sidePanel = document.getElementById('sidePanel');
                setTimeout(() => sidePanel.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
            }

            // Focus search input when switching to search
            if (panelName === 'search') {
                setTimeout(() => {
                    const input = document.getElementById('searchInput');
                    if (input) input.focus();
                }, 100);
            }
        }

        // ==================== Resize Handle ====================
        (function initResize() {
            const handle = document.getElementById('resizeHandle');
            const main = document.getElementById('main');
            const biblePanel = document.getElementById('biblePanel');
            const sidePanel = document.getElementById('sidePanel');
            let isResizing = false;

            // Apply ratio using flex-grow (avoids gap/handle overflow issues)
            function applyRatio(ratio) {
                biblePanel.style.flex = ratio + ' 1 0';
                sidePanel.style.flex = (1 - ratio) + ' 1 0';
                biblePanel.style.width = '';
                sidePanel.style.width = '';
                biblePanel.style.height = '';
                sidePanel.style.height = '';
            }

            // Restore saved ratio
            const savedRatio = localStorage.getItem('panelRatio');
            if (savedRatio) {
                const ratio = parseFloat(savedRatio);
                if (ratio > 0.2 && ratio < 0.9) {
                    applyRatio(ratio);
                }
            }

            function startResize(e) {
                isResizing = true;
                document.body.style.cursor = window.innerWidth <= 900 ? 'row-resize' : 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            }

            function doResize(e) {
                if (!isResizing) return;
                const mainRect = main.getBoundingClientRect();
                const isVertical = window.innerWidth <= 900;

                let ratio;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                if (isVertical) {
                    ratio = (clientY - mainRect.top) / mainRect.height;
                } else {
                    ratio = (clientX - mainRect.left) / mainRect.width;
                }

                // Clamp ratio
                ratio = Math.max(0.2, Math.min(0.85, ratio));

                applyRatio(ratio);
                localStorage.setItem('panelRatio', ratio.toString());
            }

            function stopResize() {
                if (!isResizing) return;
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }

            handle.addEventListener('mousedown', startResize);
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            handle.addEventListener('touchstart', startResize, { passive: false });
            document.addEventListener('touchmove', doResize, { passive: false });
            document.addEventListener('touchend', stopResize);

            // Double-click to reset
            handle.addEventListener('dblclick', () => {
                biblePanel.style.flex = '';
                sidePanel.style.flex = '';
                biblePanel.style.width = '';
                sidePanel.style.width = '';
                biblePanel.style.height = '';
                sidePanel.style.height = '';
                localStorage.removeItem('panelRatio');
            });
        })();

        // ==================== Banner Auto-Hide on Scroll ====================
        (function initBannerHide() {
            const banner = document.querySelector('h1');
            const biblePanel = document.getElementById('biblePanel');
            let lastScrollTop = 0;
            let hidden = false;
            let ignoreScroll = false;

            biblePanel.addEventListener('scroll', () => {
                if (ignoreScroll) return;

                const scrollTop = biblePanel.scrollTop;
                const delta = scrollTop - lastScrollTop;
                lastScrollTop = scrollTop;

                if (!hidden && delta > 8 && scrollTop > 50) {
                    hidden = true;
                    ignoreScroll = true;
                    banner.classList.add('banner-hidden');
                    setTimeout(() => {
                        lastScrollTop = biblePanel.scrollTop;
                        ignoreScroll = false;
                    }, 150);
                } else if (hidden && delta < -8) {
                    hidden = false;
                    ignoreScroll = true;
                    banner.classList.remove('banner-hidden');
                    setTimeout(() => {
                        lastScrollTop = biblePanel.scrollTop;
                        ignoreScroll = false;
                    }, 150);
                }
            });
        })();

        // Load JSON files
        Promise.all([
            fetch('bible.json').then(r => r.json()),
            fetch('strongs.json').then(r => r.json())
        ]).then(([bibleJson, strongsJson]) => {
            bibleData = bibleJson;
            strongsData = strongsJson;
            initializeNavigation();
            initializeSearch();
            initializeSettings();
        });

        // ==================== Navigation ====================
        function initializeNavigation() {
            const bookSelect = document.getElementById('bookSelect');
            const chapterSelect = document.getElementById('chapterSelect');

            // Build book -> chapters map
            bibleData.forEach(item => {
                const [translation, book, chapter] = item.r.split(':');
                if (!bookMap[book]) bookMap[book] = new Set();
                bookMap[book].add(chapter);
            });

            // Populate book select
            Object.keys(bookMap).forEach(book => {
                const option = document.createElement('option');
                option.value = book;
                option.textContent = book;
                bookSelect.appendChild(option);
            });

            bookSelect.addEventListener('change', () => {
                populateChapterSelect(bookSelect.value);
                loadChapter(bookSelect.value, chapterSelect.value);
            });

            chapterSelect.addEventListener('change', () => {
                loadChapter(bookSelect.value, chapterSelect.value);
            });

            // Check URL parameters first (for search result navigation)
            const urlParams = new URLSearchParams(window.location.search);
            const urlBook = urlParams.get('book');
            const urlChapter = urlParams.get('chapter');
            const urlVerse = urlParams.get('verse');

            // Initial selection - URL params > localStorage > first book
            const savedBook = localStorage.getItem('lastBook');
            const savedChapter = localStorage.getItem('lastChapter');
            const books = Object.keys(bookMap);

            let initialBook = books[0];
            let initialChapter = null;

            // Priority: URL params > localStorage > defaults
            if (urlBook && books.includes(urlBook)) {
                initialBook = urlBook;
                initialChapter = urlChapter;
            } else if (savedBook && books.includes(savedBook)) {
                initialBook = savedBook;
                initialChapter = savedChapter;
            }

            bookSelect.value = initialBook;
            populateChapterSelect(initialBook);

            // Restore saved/URL chapter if valid
            const chapters = Array.from(bookMap[initialBook]).map(String);
            if (initialChapter && chapters.includes(initialChapter)) {
                chapterSelect.value = initialChapter;
            }

            loadChapter(bookSelect.value, chapterSelect.value);

            // Scroll to specific verse if provided in URL
            if (urlVerse) {
                setTimeout(() => scrollToVerse(urlVerse), 100);
            }

            // Clear URL params after navigation (keeps URL clean)
            if (urlBook) {
                window.history.replaceState({}, '', window.location.pathname);
            }

            // Next/Prev buttons
            const prevBtn = document.getElementById('prevChapter');
            const nextBtn = document.getElementById('nextChapter');

            prevBtn.addEventListener('click', () => navigateChapter(-1));
            nextBtn.addEventListener('click', () => navigateChapter(1));

            function navigateChapter(offset) {
                const chapters = Array.from(bookMap[bookSelect.value]).sort((a, b) => a - b);
                let currentIndex = chapters.indexOf(chapterSelect.value);
                let newIndex = currentIndex + offset;

                if (newIndex < 0) {
                    const books = Object.keys(bookMap);
                    let currentBookIndex = books.indexOf(bookSelect.value);
                    currentBookIndex = (currentBookIndex - 1 + books.length) % books.length;
                    bookSelect.value = books[currentBookIndex];
                    populateChapterSelect(bookSelect.value);
                    chapterSelect.value = Array.from(bookMap[books[currentBookIndex]]).sort((a, b) => a - b).slice(-1)[0];
                } else if (newIndex >= chapters.length) {
                    const books = Object.keys(bookMap);
                    let currentBookIndex = books.indexOf(bookSelect.value);
                    currentBookIndex = (currentBookIndex + 1) % books.length;
                    bookSelect.value = books[currentBookIndex];
                    populateChapterSelect(bookSelect.value);
                    chapterSelect.value = Array.from(bookMap[books[currentBookIndex]])[0];
                } else {
                    chapterSelect.value = chapters[newIndex];
                }

                loadChapter(bookSelect.value, chapterSelect.value);
            }
        }

        function populateChapterSelect(book) {
            const chapterSelect = document.getElementById('chapterSelect');
            chapterSelect.innerHTML = '';
            const chapters = Array.from(bookMap[book]).sort((a, b) => a - b);
            chapters.forEach(ch => {
                const option = document.createElement('option');
                option.value = ch;
                option.textContent = ch;
                chapterSelect.appendChild(option);
            });
        }

        // Load and render chapter (interlinear)
        function loadChapter(book, chapter) {
            // Save to localStorage
            localStorage.setItem('lastBook', book);
            localStorage.setItem('lastChapter', chapter);

            const panel = document.getElementById('biblePanel');
            panel.innerHTML = '';

            currentChapter = bibleData
                .filter(item => {
                    const [translation, b, c] = item.r.split(':');
                    return b === book && c === chapter;
                })
                .sort((a, b) => a.o - b.o);

            currentChapter.forEach(item => {
                // Headers
                if (item.h) {
                    const level = Math.min(Math.max(item.h, 1), 4);
                    const heading = document.createElement(`h${level}`);
                    heading.textContent = item.t;
                    panel.appendChild(heading);
                }

                // Interlinear verse
                if (item.d && item.d.length > 0) {
                    const [, , , v] = item.r.split(':');
                    const isVerseZero = v === '0';

                    const verseDiv = document.createElement('div');
                    verseDiv.className = isVerseZero ? 'verse verse-zero' : 'verse';

                    // create the first line container
                    let currentLine = createLineContainer(null);

                    // add verse number inside that first line (skip for verse 0)
                    if (!isVerseZero) {
                        const verseNumber = document.createElement('span');
                        verseNumber.textContent = v;
                        verseNumber.className = 'verse-number';
                        verseNumber.dataset.tooltip = 'Click to copy verse';
                        verseNumber.addEventListener('click', (e) => {
                            e.stopPropagation();
                            copyVerseText(verseDiv, book, chapter, v);
                        });
                        currentLine.appendChild(verseNumber);
                        currentLine.appendChild(document.createTextNode(" "));
                    }

                    item.d.forEach((wordObj, index) => {
                        // detect line breaks - but only create new line if current line has words
                        // Short class names: l=line, n=indented, d=double-indent, p=paragraph
                        const hasWords = currentLine.querySelector('.word') !== null;
                        const isLine = wordObj.class && wordObj.class.includes("l");
                        const isIndented = wordObj.class && wordObj.class.includes("n");
                        const isDoubleIndented = wordObj.class && wordObj.class.includes("d");

                        // Handle line breaks (a word can have both "l" and "n")
                        if (isLine || isIndented || isDoubleIndented) {
                            if (hasWords) {
                                verseDiv.appendChild(currentLine);
                                currentLine = createLineContainer(isIndented ? 'n' : (isDoubleIndented ? 'd' : null));
                            } else {
                                // First word - just add indented class if needed
                                if (isIndented) {
                                    currentLine.classList.add('n');
                                } else if (isDoubleIndented) {
                                    currentLine.classList.add('d');
                                }
                            }
                        }

                        // detect paragraph start - add spacing to the current line
                        if (wordObj.class && wordObj.class.includes("p")) {
                            currentLine.classList.add('p');
                        }

                        // build word
                        const wordSpan = document.createElement('span');
                        wordSpan.className = "word tooltip";
                        const [english, original, translit] = wordObj.t.split('|');
                        wordSpan.textContent = english;

                        if (wordObj.class) {
                            (Array.isArray(wordObj.class) ? wordObj.class : [wordObj.class])
                                .forEach(cls => wordSpan.classList.add(cls));
                        }

                        // metadata
                        wordSpan.dataset.strongs = wordObj.s || '';
                        wordSpan.dataset.original = original || '';
                        wordSpan.dataset.translit = translit || '';
                        wordSpan.dataset.parsing = wordObj.c || '';
                        wordSpan.dataset.english = english || '';
                        wordSpan.dataset.tooltip = `${original || ''} | ${translit || ''}`;
                        wordSpan.addEventListener('click', () => displayDefinition(wordSpan));

                        currentLine.appendChild(wordSpan);
                        currentLine.appendChild(document.createTextNode(' '));
                    });

                    // append last line to verse
                    verseDiv.appendChild(currentLine);

                    panel.appendChild(verseDiv);
                }
            });
        }

        function createLineContainer(indentClass) {
            // indentClass: 'n' for indented, 'd' for double-indented, null for normal
            const div = document.createElement('div');
            div.className = 'line-div';
            if (indentClass) {
                div.classList.add(indentClass);
            }
            return div;
        }

        // ==================== Word Definition ====================
        function displayDefinition(wordSpan) {
            // Switch to word panel without scrolling (don't scroll away from text)
            switchPanel('word', false);

            document.querySelectorAll('.word.selected').forEach(w => w.classList.remove('selected'));
            wordSpan.classList.add('selected');

            // Normalize Strong's to H/G + 4 digits
            let strongs = wordSpan.dataset.strongs || '';
            let strongsDisplay = strongs;
            if (strongs) {
                const letter = strongs[0].toUpperCase();     // 'H' or 'G'
                const number = strongs.slice(1).padStart(4, '0');
                strongs = letter + number;                   // e.g., H0430
                strongsDisplay = strongs;
            }

            const definitionRaw = strongsData[strongs] || 'Definition not found.';
            const definition = String(definitionRaw).replace(/\\+/g, '').replace(/\n/g, '<br>');

            const parsing = wordSpan.dataset.parsing
                ? `<p><b>Parsing:</b> ${wordSpan.dataset.parsing}</p>`
                : '';

            // Create search button for Strong's number
            const searchBtn = strongs
                ? `<button class="search-strongs-btn" onclick="searchStrongsInBible('${strongs}')" title="Find all occurrences">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Search Bible for ${strongsDisplay}
                   </button>`
                : '';

            const content = `
      <p><b>Word:</b> ${wordSpan.dataset.english}</p>
      <p><b>Original:</b> ${wordSpan.dataset.original}</p>
      <p><b>Transliteration:</b> ${wordSpan.dataset.translit}</p>
      <p><b>Strong's ${strongsDisplay}:</b><br>${definition}</p>
      ${parsing}
      ${searchBtn}
    `;

            document.getElementById('definitionContent').innerHTML = content;
        }

        // Search for Strong's number in the inline search panel
        function searchStrongsInBible(strongs) {
            switchPanel('search');
            const input = document.getElementById('searchInput');
            input.value = strongs;
            setSearchType('strongs');
            setTimeout(performSearch, 50);
        }

        // Scroll to a specific verse
        function scrollToVerse(verseNum) {
            const verses = document.querySelectorAll('.verse');
            for (const verse of verses) {
                const verseNumber = verse.querySelector('.verse-number');
                if (verseNumber && verseNumber.textContent === verseNum) {
                    verse.classList.add('highlight-verse');
                    verse.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Remove highlight after animation
                    setTimeout(() => verse.classList.remove('highlight-verse'), 3000);
                    break;
                }
            }
        }

        // Copy verse text to clipboard
        function copyVerseText(verseDiv, book, chapter, verseNum) {
            // Get all words from the verse
            const words = verseDiv.querySelectorAll('.word');
            const verseText = Array.from(words).map(w => w.textContent).join(' ');
            const reference = `${book} ${chapter}:${verseNum}`;
            const fullText = `${verseText} (${reference})`;

            navigator.clipboard.writeText(fullText).then(() => {
                // Show feedback
                const verseNumber = verseDiv.querySelector('.verse-number');
                const originalText = verseNumber.textContent;
                verseNumber.textContent = 'Copied!';
                verseNumber.classList.add('copied');
                setTimeout(() => {
                    verseNumber.textContent = originalText;
                    verseNumber.classList.remove('copied');
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy verse:', err);
            });
        }

        // ==================== Search System ====================
        let isSearching = false;
        let searchType = 'text';

        function initializeSearch() {
            // Search type toggle
            document.querySelectorAll('.search-type-btn').forEach(btn => {
                btn.addEventListener('click', () => setSearchType(btn.dataset.type));
            });

            // Toggle hint for non-exact phrase search
            document.getElementById('exactPhrase').addEventListener('change', (e) => {
                document.getElementById('multiWordHint').style.display = e.target.checked ? 'none' : 'block';
            });

            // Search triggers
            document.getElementById('searchGoBtn').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
        }

        function setSearchType(type) {
            searchType = type;
            document.querySelectorAll('.search-type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            const searchInput = document.getElementById('searchInput');
            const textOptions = document.getElementById('textOptions');
            const strongsOptions = document.getElementById('strongsOptions');

            if (type === 'strongs') {
                searchInput.placeholder = "Enter Strong's number (e.g., H430, G2316)...";
                textOptions.style.display = 'none';
                strongsOptions.style.display = 'flex';
            } else {
                searchInput.placeholder = "Search for words or phrases...";
                textOptions.style.display = 'flex';
                strongsOptions.style.display = 'none';
            }
        }

        function performSearch() {
            if (isSearching) return;

            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            isSearching = true;
            const statusEl = document.getElementById('searchStatus');
            const resultsEl = document.getElementById('searchResults');

            statusEl.innerHTML = '<span class="loading">Searching...</span>';
            resultsEl.innerHTML = '';

            setTimeout(() => {
                let results;
                if (searchType === 'strongs') {
                    results = searchByStrongs(query);
                } else {
                    const caseSensitive = document.getElementById('caseSensitive').checked;
                    const wholeWord = document.getElementById('wholeWord').checked;
                    const exactPhrase = document.getElementById('exactPhrase').checked;
                    results = searchBible(query, caseSensitive, wholeWord, exactPhrase);
                }
                displaySearchResults(results, query, searchType === 'text' && document.getElementById('caseSensitive').checked);
                isSearching = false;
            }, 50);
        }

        function searchByStrongs(query) {
            const results = [];
            let strongsNum = query.toUpperCase().trim();
            if (!strongsNum.match(/^[HG]\d+$/)) {
                const digits = strongsNum.replace(/\D/g, '');
                if (digits) {
                    strongsNum = 'H' + digits;
                }
            }

            const normalizedSearch = strongsNum[0] + strongsNum.slice(1).replace(/^0+/, '');

            bibleData.forEach(item => {
                const parts = item.r.split(':');
                if (parts.length < 4) return;
                const [translation, book, chapter, verseNum] = parts;
                if (item.h || !item.d || !Array.isArray(item.d)) return;

                const matchingWords = [];
                item.d.forEach(wordObj => {
                    if (!wordObj.s || !wordObj.t) return;
                    const storedStrongs = wordObj.s.toUpperCase();
                    const normalizedStored = storedStrongs[0] + storedStrongs.slice(1).replace(/^0+/, '');
                    if (normalizedStored === normalizedSearch) {
                        const english = wordObj.t.split('|')[0];
                        if (english && !matchingWords.includes(english)) {
                            matchingWords.push(english);
                        }
                    }
                });

                if (matchingWords.length > 0) {
                    const verseText = extractVerseText(item.d);
                    results.push({
                        book, chapter, verse: verseNum,
                        text: verseText,
                        reference: `${book} ${chapter}:${verseNum}`,
                        strongsNum,
                        matchingWords
                    });
                }
            });

            return results;
        }

        function searchBible(query, caseSensitive, wholeWord, exactPhrase) {
            const results = [];
            const searchQuery = caseSensitive ? query : query.toLowerCase();
            const searchWords = exactPhrase ? null : searchQuery.split(/\s+/).filter(w => w.length > 0);

            let regex = null;
            if (wholeWord && exactPhrase) {
                const escapedQuery = searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                regex = new RegExp(`\\b${escapedQuery}\\b`, caseSensitive ? 'g' : 'gi');
            }

            bibleData.forEach(item => {
                const parts = item.r.split(':');
                if (parts.length < 4) return;
                const [translation, book, chapter, verseNum] = parts;
                if (item.h || !item.d || !Array.isArray(item.d)) return;

                const verseText = extractVerseText(item.d);
                if (!verseText) return;

                const textToSearch = caseSensitive ? verseText : verseText.toLowerCase();
                let matches = false;

                if (!exactPhrase && searchWords && searchWords.length > 1) {
                    matches = searchWords.every(word => {
                        if (wholeWord) {
                            const wordRegex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, caseSensitive ? '' : 'i');
                            return wordRegex.test(textToSearch);
                        }
                        return textToSearch.includes(word);
                    });
                } else if (wholeWord && regex) {
                    matches = regex.test(textToSearch);
                    regex.lastIndex = 0;
                } else {
                    matches = textToSearch.includes(searchQuery);
                }

                if (matches) {
                    results.push({
                        book, chapter, verse: verseNum,
                        text: verseText,
                        reference: `${book} ${chapter}:${verseNum}`
                    });
                }
            });

            return results;
        }

        function extractVerseText(wordArray) {
            let text = '';
            wordArray.forEach(wordObj => {
                if (wordObj.t) {
                    const english = wordObj.t.split('|')[0];
                    if (english) {
                        if (text.length > 0) text += ' ';
                        text += english;
                    }
                }
            });
            return text.trim();
        }

        function displaySearchResults(results, query, caseSensitive) {
            const statusEl = document.getElementById('searchStatus');
            const resultsEl = document.getElementById('searchResults');

            if (results.length === 0) {
                statusEl.innerHTML = `<span class="no-results">No results found for "<strong>${escapeHtml(query)}</strong>"</span>`;
                resultsEl.innerHTML = '';
                return;
            }

            const isStrongsSearch = searchType === 'strongs';
            statusEl.innerHTML = `<span class="results-count">Found <strong>${results.length}</strong> result${results.length !== 1 ? 's' : ''} for "<strong>${escapeHtml(query)}</strong>"</span>`;

            // Group results by book
            const groupedResults = {};
            results.forEach(result => {
                if (!groupedResults[result.book]) groupedResults[result.book] = [];
                groupedResults[result.book].push(result);
            });

            let html = '';
            for (const book in groupedResults) {
                html += `<div class="result-book">
                    <h3 class="book-header">${book} <span class="count">(${groupedResults[book].length})</span></h3>
                    <div class="book-results">`;

                groupedResults[book].forEach(result => {
                    let highlightedText;
                    if (isStrongsSearch && result.matchingWords && result.matchingWords.length > 0) {
                        highlightedText = highlightStrongsWords(result.text, result.matchingWords);
                    } else {
                        highlightedText = highlightMatches(result.text, query, caseSensitive);
                    }
                    html += `
                        <a href="#" class="result-item" data-book="${escapeHtml(result.book)}" data-chapter="${result.chapter}" data-verse="${result.verse}">
                            <span class="result-reference">${result.reference}</span>
                            <span class="result-text">${highlightedText}</span>
                        </a>`;
                });

                html += '</div></div>';
            }

            resultsEl.innerHTML = html;

            // Add click handlers to navigate inline
            resultsEl.querySelectorAll('.result-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const book = item.dataset.book;
                    const chapter = item.dataset.chapter;
                    const verse = item.dataset.verse;

                    // Navigate to the book/chapter
                    const bookSelect = document.getElementById('bookSelect');
                    const chapterSelect = document.getElementById('chapterSelect');
                    bookSelect.value = book;
                    populateChapterSelect(book);
                    chapterSelect.value = chapter;
                    loadChapter(book, chapter);

                    // Scroll to verse after render
                    setTimeout(() => scrollToVerse(verse), 100);
                });
            });
        }

        function highlightMatches(text, query, caseSensitive) {
            const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedQuery})`, caseSensitive ? 'g' : 'gi');
            return escapeHtml(text).replace(regex, '<mark>$1</mark>');
        }

        function highlightStrongsWords(text, matchingWords) {
            let result = escapeHtml(text);
            matchingWords.forEach(word => {
                const cleanWord = word.replace(/^[^\w]+|[^\w]+$/g, '').trim();
                if (!cleanWord) return;
                const escapedWord = cleanWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedWord})(?=[\\s,.:;!?'"\\)\\]\\-]|$)`, 'gi');
                result = result.replace(regex, '<mark>$1</mark>');
            });
            return result;
        }

        // ==================== Settings System ====================
        function initializeSettings() {
            const root = document.documentElement;
            const themeButtons = document.querySelectorAll('#panelSettings .preset-button');
            const fontSelect = document.getElementById('fontSelect');
            const fontSizeSelect = document.getElementById('fontSizeSelect');
            const lineHeightSelect = document.getElementById('lineHeightSelect');
            const currentFontDisplay = document.getElementById('currentFontDisplay');
            const currentSizeDisplay = document.getElementById('currentSizeDisplay');
            const currentLineHeightDisplay = document.getElementById('currentLineHeightDisplay');

            const fontNames = {
                'system': 'System Default', 'georgia': 'Georgia', 'palatino': 'Palatino',
                'times': 'Times New Roman', 'garamond': 'Garamond', 'baskerville': 'Baskerville',
                'charter': 'Charter', 'merriweather': 'Merriweather', 'lora': 'Lora',
                'source-serif': 'Source Serif', 'literata': 'Literata', 'eb-garamond': 'EB Garamond',
                'libre-baskerville': 'Libre Baskerville', 'open-sans': 'Open Sans',
                'roboto': 'Roboto', 'inter': 'Inter', 'atkinson': 'Atkinson Hyperlegible'
            };
            const sizeNames = { 'small': 'Small', 'medium': 'Medium', 'large': 'Large', 'x-large': 'Extra Large' };
            const lineHeightNames = { 'compact': 'Compact', 'normal': 'Normal', 'relaxed': 'Relaxed', 'spacious': 'Spacious' };

            function updateDisplayLabels() {
                currentFontDisplay.textContent = fontNames[fontSelect.value] || fontSelect.value;
                currentSizeDisplay.textContent = sizeNames[fontSizeSelect.value] || fontSizeSelect.value;
                currentLineHeightDisplay.textContent = lineHeightNames[lineHeightSelect.value] || lineHeightSelect.value;
            }

            // Load saved settings
            const savedPreset = localStorage.getItem('themePreset') || 'default';
            const savedFont = localStorage.getItem('fontFamily') || 'system';
            const savedFontSize = localStorage.getItem('fontSize') || 'medium';
            const savedLineHeight = localStorage.getItem('lineHeight') || 'normal';

            // Apply saved settings
            fontSelect.value = savedFont;
            fontSizeSelect.value = savedFontSize;
            lineHeightSelect.value = savedLineHeight;
            updateThemeActiveButton(savedPreset);
            updateDisplayLabels();

            // Theme button listeners
            themeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = btn.dataset.preset;
                    setTheme(preset);
                    localStorage.setItem('themePreset', preset);
                    updateThemeActiveButton(preset);
                    showConfirmation(`Theme: ${getThemeName(preset)}`);
                });
            });

            // Font select listener
            fontSelect.addEventListener('change', () => {
                const font = fontSelect.value;
                setFont(font);
                localStorage.setItem('fontFamily', font);
                updateDisplayLabels();
                showConfirmation(`Font: ${fontNames[font]}`);
            });

            // Font size select listener
            fontSizeSelect.addEventListener('change', () => {
                const size = fontSizeSelect.value;
                setFontSize(size);
                localStorage.setItem('fontSize', size);
                updateDisplayLabels();
                showConfirmation(`Size: ${sizeNames[size]}`);
            });

            // Line height select listener
            lineHeightSelect.addEventListener('change', () => {
                const lineHeight = lineHeightSelect.value;
                setLineHeight(lineHeight);
                localStorage.setItem('lineHeight', lineHeight);
                updateDisplayLabels();
                showConfirmation(`Spacing: ${lineHeightNames[lineHeight]}`);
            });

            // Keyboard shortcut: Ctrl+Shift+T to toggle dark mode
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
                    e.preventDefault();
                    const currentPreset = localStorage.getItem('themePreset') || 'default';
                    const newPreset = currentPreset === 'dark' ? 'default' : 'dark';
                    setTheme(newPreset);
                    localStorage.setItem('themePreset', newPreset);
                    updateThemeActiveButton(newPreset);
                    showConfirmation(`Switched to ${getThemeName(newPreset)}`);
                }
            });

            function setTheme(presetName) {
                if (presetName === 'default') {
                    root.removeAttribute('data-preset');
                } else {
                    root.setAttribute('data-preset', presetName);
                }
            }

            function setFont(fontName) {
                if (fontName === 'system') {
                    root.removeAttribute('data-font');
                } else {
                    root.setAttribute('data-font', fontName);
                }
            }

            function setFontSize(size) {
                if (size === 'medium') {
                    root.removeAttribute('data-font-size');
                } else {
                    root.setAttribute('data-font-size', size);
                }
            }

            function setLineHeight(lineHeight) {
                if (lineHeight === 'normal') {
                    root.removeAttribute('data-line-height');
                } else {
                    root.setAttribute('data-line-height', lineHeight);
                }
            }

            function updateThemeActiveButton(activePreset) {
                themeButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.preset === activePreset);
                });
            }

            function getThemeName(preset) {
                const names = {
                    'default': 'Default Blue', 'dark': 'Dark Mode', 'blue': 'Ocean Teal',
                    'green': 'Forest Green', 'orange': 'Sunset Orange', 'purple': 'Purple Haze',
                    'sepia': 'Sepia Classic', 'grayscale': 'Grayscale'
                };
                return names[preset] || preset;
            }
        }

        function showConfirmation(message) {
            let toast = document.getElementById('settings-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'settings-toast';
                toast.style.cssText = `
                    position: fixed; bottom: 20px; right: 20px;
                    background: var(--toast-bg); color: var(--toast-text);
                    padding: 12px 20px; border-radius: var(--radius-medium);
                    box-shadow: var(--shadow-strong); opacity: 0;
                    transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease;
                    z-index: 1000; font-size: 0.9rem; pointer-events: none;
                `;
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; }, 10);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(20px)'; }, 2000);
        }

        // ==================== Notes System ====================
        function getNotesKey(book, chapter, verse) {
            return `note:${book}:${chapter}:${verse}`;
        }

        function getAllNotes() {
            const notes = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('note:')) {
                    notes[key] = localStorage.getItem(key);
                }
            }
            return notes;
        }

        function getNote(book, chapter, verse) {
            return localStorage.getItem(getNotesKey(book, chapter, verse)) || '';
        }

        function saveNote(book, chapter, verse, text) {
            const key = getNotesKey(book, chapter, verse);
            if (text.trim()) {
                localStorage.setItem(key, text);
            } else {
                localStorage.removeItem(key);
            }
            updateNoteIndicators();
        }

        function updateNoteIndicators() {
            const book = document.getElementById('bookSelect').value;
            const chapter = document.getElementById('chapterSelect').value;

            document.querySelectorAll('.verse').forEach(verseEl => {
                const verseNumber = verseEl.querySelector('.verse-number');
                if (!verseNumber) return;

                const verseNum = verseNumber.textContent;
                const hasNote = getNote(book, chapter, verseNum);

                // Remove existing note button if any
                const existingBtn = verseEl.querySelector('.note-btn');
                if (existingBtn) existingBtn.remove();

                // Add note button
                const noteBtn = document.createElement('button');
                noteBtn.className = hasNote ? 'note-btn has-note' : 'note-btn';
                noteBtn.title = hasNote ? 'View/Edit note' : 'Add note';
                noteBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>`;
                noteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openNoteModal(book, chapter, verseNum);
                });

                // Insert after verse number
                verseNumber.after(noteBtn);
            });
        }

        function openNoteModal(book, chapter, verse) {
            // Remove existing modal if any
            const existingModal = document.getElementById('noteModal');
            if (existingModal) existingModal.remove();

            const note = getNote(book, chapter, verse);

            const modal = document.createElement('div');
            modal.id = 'noteModal';
            modal.className = 'note-modal-overlay';
            modal.innerHTML = `
                <div class="note-modal">
                    <div class="note-modal-header">
                        <h3>Note for ${book} ${chapter}:${verse}</h3>
                        <button class="note-modal-close" title="Close">&times;</button>
                    </div>
                    <textarea id="noteText" placeholder="Write your note here...">${escapeHtml(note)}</textarea>
                    <div class="note-modal-actions">
                        <button class="note-btn-delete" ${!note ? 'style="display:none"' : ''}>Delete</button>
                        <button class="note-btn-save">Save</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Focus textarea
            const textarea = modal.querySelector('#noteText');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);

            // Event handlers
            modal.querySelector('.note-modal-close').addEventListener('click', () => modal.remove());
            modal.querySelector('.note-btn-save').addEventListener('click', () => {
                saveNote(book, chapter, verse, textarea.value);
                modal.remove();
            });
            modal.querySelector('.note-btn-delete').addEventListener('click', () => {
                saveNote(book, chapter, verse, '');
                modal.remove();
            });

            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            // Close on Escape
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update note indicators after chapter loads
        const originalLoadChapter = loadChapter;
        loadChapter = function(book, chapter) {
            originalLoadChapter(book, chapter);
            setTimeout(updateNoteIndicators, 0);
        };
    </script>

</body>

</html>